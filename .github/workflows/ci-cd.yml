# .github/workflows/ci-cd.yml

name: CI/CD for Hotel Mawar Indah API

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'

      - name: Install Dependencies
        run: go mod download

      - name: Run Tests
        run: go test ./... -v

      - name: Build Docker Image
        run: docker build -t hotel-mawar-indah-availability-api .

      - name: Push Docker Image
        env:
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
          DOCKER_HUB_ACCESS_TOKEN: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
        run: |
          echo "$DOCKER_HUB_ACCESS_TOKEN" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
          docker tag hotel-mawar-indah-availability-api:latest $DOCKER_HUB_USERNAME/hotel-mawar-indah-availability-api:latest
          docker push $DOCKER_HUB_USERNAME/hotel-mawar-indah-availability-api:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to Server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
        run: |
          echo "$SSH_PRIVATE_KEY" | ssh-add -
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'EOF'
            docker pull $DOCKER_HUB_USERNAME/hotel-mawar-indah-availability-api:latest
            docker-compose down
            docker-compose up -d --build
          EOF
